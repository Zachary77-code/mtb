# MTB 系统架构设计文档

> 本文档描述 MTB 系统的架构设计决策和关键判断逻辑。

---

## 目录

- [术语说明](#术语说明)

0. [系统架构总览](#0-系统架构总览)
1. [系统设计理念](#1-系统设计理念)
2. [两阶段研究设计](#2-两阶段研究设计)
3. [研究模式选择逻辑](#3-研究模式选择逻辑)
4. [收敛判断机制](#4-收敛判断机制)
5. [证据图设计决策](#5-证据图设计决策)

   - [5.5 Neo4j 图数据库集成](#55-neo4j-图数据库集成)
   - [5.6 交互式可视化（Cytoscape.js）](#56-交互式可视化cytoscapejs)
6. [模型分层策略](#6-模型分层策略)
7. [报告生成策略](#7-报告生成策略)

---

## 术语说明


| 术语                    | 含义                                                                                                                                         |
| ------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------- |
| **Agent（智能体）**     | 系统中承担特定角色的 AI 模块，类似一位专科医生。每个 Agent 拥有独立的专业知识和可调用的工具                                                  |
| **PlanAgent**           | 负责制定研究计划、评估研究进展和判断是否收敛的"总协调人" Agent                                                                               |
| **Chair（主席）**       | 最终报告的撰写者 Agent，汇总所有其他 Agent 的研究成果，输出 13 模块结构化报告                                                                |
| **研究方向**            | PlanAgent 分析病例后列出的具体研究任务，如"分析 EGFR L858R 变异的药物敏感性"。每个方向指定负责的 Agent、优先级和目标                         |
| **迭代**                | 一轮研究循环。每次迭代中，各 Agent 执行研究 → 更新证据图 → PlanAgent 评估进展。可理解为"研究的一个回合"                                    |
| **收敛**                | PlanAgent 判定当前证据已足够支撑高质量报告，不再需要继续研究。类似学术研究中"数据饱和"的概念                                                 |
| **广度优先研究 (BFRS)** | 对一个方向进行 1-2 次工具查询，快速覆盖尽可能多的相关信息。类似文献综述的初步筛查                                                            |
| **深度优先研究 (DFRS)** | 对一个方向进行 3-5 次连续深入查询，追踪引用链和证据来源。类似对关键论文的深入追踪                                                            |
| **证据图**              | 系统用来组织所有研究发现的结构化知识库。将每个发现拆解为实体（基因、药物等）、关系（敏感、耐药等）和观察（带等级的事实陈述和上下文溯源信息） |
| **证据等级 (A–E)**     | 基于 CIViC 标准的证据质量分级：A = 多项独立研究验证，B = 临床试验数据，C = 病例报告，D = 临床前研究，E = 间接推断                            |
| **完成度**              | 某个研究方向已收集证据的加权得分占目标分的百分比，用于量化"这个方向还差多少"                                                                 |
| **待深入研究线索**      | 研究 Agent 在工作中标记的"值得进一步追踪"的发现，如发现了耐药突变但缺乏临床验证数据                                                          |
| **Phase 1 / Phase 2**   | 两个研究阶段。Phase 1 由病理、遗传、试验三位 Agent 并行研究"患者是什么情况"；Phase 2 由 Oncologist 基于 Phase 1 结论研究"应该怎么治"         |

---

## 0. 系统架构总览

```mermaid
flowchart TD
    PDF["患者病历 PDF"] --> Parse["提取病历文本"]
    Parse --> Plan["PlanAgent 制定研究计划<br/>列出所有研究方向 · 初始化证据图"]

    Plan --> P1Start

    subgraph Research["研究阶段"]

        subgraph P1["Phase 1 — 这个患者是什么情况？（最多 7 轮迭代）"]
            P1Start["分配研究方向"] --> Path["Pathologist<br/>病理 / 影像分析"]
            P1Start --> Gene["Geneticist<br/>分子特征分析"]
            P1Start --> Recr["Recruiter<br/>临床试验匹配"]
            Path --> Merge["汇总本轮发现<br/>写入证据图"]
            Gene --> Merge
            Recr --> Merge
            Merge --> Eval1["PlanAgent 评估<br/>证据够了吗？"]
            Eval1 -->|"继续研究"| P1Start
        end

        Eval1 -->|"收敛"| GenP1["生成 Phase 1 领域报告<br/>病理 · 分子 · 试验"]
        GenP1 --> P2Plan["PlanAgent 为 Oncologist<br/>生成治疗相关研究方向"]
        P2Plan --> Onco

        subgraph P2["Phase 2 — 应该怎么治？（最多 7 轮迭代）"]
            Onco["Oncologist<br/>治疗方案研究"] --> Merge2["写入证据图"]
            Merge2 --> Eval2["PlanAgent 评估<br/>证据够了吗？"]
            Eval2 -->|"继续研究"| Onco
        end

        Eval2 -->|"收敛"| GenP2["生成 Oncologist 报告<br/>提取引用和试验信息"]
    end

    GenP2 --> Chair["Chair 撰写最终报告<br/>整合 4 份领域报告 + 证据图 → 最终报告"]
    Chair --> Verify{"格式验证<br/>13 模块是否完整？"}
    Verify -->|"通过"| HTML["输出终版 HTML 报告<br/>+ 交互式证据图可视化"]
    Verify -->|"缺失"| Retry["Chair 补充缺失模块"]
    Retry --> Verify
```

---

## 1. 系统设计理念

### 1.1 为什么用多 Agent 而非单一 LLM

**问题**: 肿瘤分子委员会报告涉及病理学、分子遗传学、临床试验、肿瘤内科等多个专业领域，单一 LLM 调用无法：

- 为每个领域配置专属工具集
- 对不同领域施加精确的角色约束
- 支持迭代式证据收集（单次调用的工具使用次数有限）

**设计决策**: 6 个专业 Agent，每个 Agent 拥有独立的：

- 系统提示词（领域专家角色）
- 工具集（只访问与其专业相关的 API）
- 温度参数（研究类偏低 0.2，综合类偏高 0.3）

### 1.2 为什么需要 Evidence Graph

**问题**: 传统 Agent 工作流中，各 Agent 产出的是自由文本，存在：

- 信息无法结构化对比（同一变异的不同 Agent 发现如何关联？）
- 证据质量无法量化（收集了多少 A 级证据？哪些方向还缺乏数据？）
- 收敛无法判断（研究做到什么程度算"够了"？）

**设计决策**: 引入 Entity-Edge-Observation 证据图作为全局知识载体：

- **结构化**: 每个发现被拆解为实体（基因、药物、疾病等）+ 关系（敏感、耐药、治疗等）+ 观察（带证据等级的事实陈述）
- **可量化**: 每个观察携带 CIViC 证据等级（A-E），可计算加权得分
- **可查询**: 收敛判断和报告生成都可以直接查询证据图

### 1.3 为什么用 PlanAgent 统一调度

**问题**: 早期设计中，各 Agent 独立决定自己的研究方向，导致：

- 研究方向重叠（两个 Agent 查同一篇文献）
- 覆盖不均（某些报告模块缺乏证据）
- 无统一收敛标准

**设计决策**: PlanAgent 承担三个职责：

1. **初始规划**: 分析病例后，生成结构化研究计划（包含 10-15 个研究方向），每个方向指定负责 Agent、优先级、目标模块
2. **动态调整**: 每次迭代后评估证据质量，调整研究方向的优先级和模式
3. **收敛判断**: 统一判断何时停止研究、进入下一阶段

---

## 2. 两阶段研究设计

### 2.1 为什么分两个阶段

**核心原因**: Oncologist 的治疗决策必须建立在其他 Agent 的研究结论之上。

```
Phase 1 回答: "这个患者是什么情况？"
  - Pathologist: 病理分型、分期、影像特征
  - Geneticist: 基因变异、通路分析、耐药机制
  - Recruiter: 可匹配的临床试验

Phase 2 回答: "应该怎么治？"
  - Oncologist: 基于 Phase 1 结论制定治疗方案
                ↑ 必须知道分子特征才能选药
                ↑ 必须知道有哪些试验才能推荐
                ↑ 必须知道耐药机制才能规划后线
```

如果所有 Agent 并行研究，Oncologist 在不了解分子特征的情况下制定治疗方案，会导致方案与实际情况脱节。

### 2.2 Phase 1: 为什么并行

Phase 1 的三个 Agent 研究的是**独立的知识领域**：

- Pathologist 查病理数据库 → 不依赖其他 Agent
- Geneticist 查变异数据库 → 不依赖其他 Agent
- Recruiter 查临床试验库 → 不依赖其他 Agent

并行执行可以将 Phase 1 的研究时间从 3x 降低到 1x。

**并行状态合并**: 三个 Agent 同时执行后，系统通过自定义合并策略整合各自对证据图和研究计划的更新（按标准标识去重合并实体，按方向 ID 合并研究进展）。

### 2.3 Phase 2: 为什么串行

Phase 2 只有 Oncologist 一个 Agent，因为：

- 治疗方案需要综合所有 Phase 1 信息
- Oncologist 需要查询药物相互作用、剂量调整等，这些依赖于已知的分子特征
- Phase 2 的研究方向由 PlanAgent 根据 Phase 1 报告**专门生成**

### 2.4 Phase 1 → Phase 2 转换

Phase 1 收敛后，系统执行三个步骤：

1. **报告合成**: 每个 Phase 1 Agent 从证据图中提取**自己收集的证据**，生成领域报告
2. **方向生成**: PlanAgent 读取三份领域报告，生成 Oncologist 专用的研究方向（如 "评估 EGFR L858R 一线治疗方案"、"分析铂类联合方案安全性"）
3. **Phase 2 启动**: Oncologist 带着 Phase 1 报告作为上下文、新的研究方向作为任务，开始独立研究

---

## 3. 研究模式选择逻辑

### 3.1 BFRS vs DFRS

系统支持两种研究模式，模拟人类研究员的行为：


|              | BFRS (广度优先)        | DFRS (深度优先)         |
| -------------- | ------------------------ | ------------------------- |
| **类比**     | 文献综述的初步扫描     | 对关键发现的深入追踪    |
| **工具调用** | 1-3 次/方向            | 3-5 次连续              |
| **目标**     | 发现尽可能多的相关证据 | 提升已有证据的等级      |
| **适用场景** | 研究初期、证据稀少时   | 有 D/E 级证据需要验证时 |

### 3.2 模式分配机制

PlanAgent 在每次迭代后，为**每个研究方向**独立分配下一轮的研究模式。

#### PlanAgent 综合判断（主路径）

模式分配的主要决策者是 PlanAgent。它在每次迭代后会：

1. **阅读每个方向的完整证据**：包括已收集的实体、关系、观察内容及其证据等级，确保判断基于全量信息
2. **评估证据质量与覆盖率**：该方向的完成标准是否被已有发现所覆盖？关键问题是否已有高等级证据支撑？
3. **审查待深入研究线索**：研究 Agent 在工作中可能标记"需要进一步追踪"的发现（例如发现了某个耐药突变但缺乏临床验证数据）。PlanAgent 会逐条判断这些线索是否已被后续研究覆盖、对报告质量的影响程度（关键 / 重要 / 次要）
4. **为每个方向选择模式并给出理由**：
   - **skip** — 证据充分、待深入项均已覆盖 → 不再研究
   - **广度优先 (BFRS)** — 覆盖面不足、多个关键问题尚未触及 → 先铺开收集
   - **深度优先 (DFRS)** — 证据等级偏低、存在矛盾、或有关键待深入项未解决 → 集中深入

### 3.3 迭代间模式演变

典型研究过程的模式演变：

```
迭代 1: 全部 BFRS  → 广泛收集初步证据
迭代 2: 大部分 BFRS → 补充遗漏的方向
迭代 3: 混合 BFRS/DFRS → 部分方向开始深入
迭代 4: 大部分 DFRS → 多数方向已有基础，需提升质量
迭代 5: DFRS + skip → 高完成度方向跳过
迭代 6: 收敛 → 所有方向达标
```

---

## 4. 收敛判断机制

### 4.1 设计原则

收敛判断需要回答一个核心问题: **"当前收集的证据是否足以支撑高质量报告？"**

这不能简单用"收集了 N 条证据"来判断，因为：

- 10 条 A 级证据 >> 100 条 E 级证据
- 覆盖 3 个模块的证据 < 覆盖 9 个模块的证据
- 有矛盾证据时需要更多佐证

### 4.2 证据质量评分体系

每条证据按 CIViC 标准分级，使用加权评分：


| 等级 | 含义             | 权重 | 相当于      |
| ------ | ------------------ | ------ | ------------- |
| A    | 多项独立研究验证 | 5.0  | 5 个 E 级   |
| B    | 临床试验数据     | 3.0  | 3 个 E 级   |
| C    | 病例报告         | 2.0  | 2 个 E 级   |
| D    | 临床前研究       | 1.5  | 1.5 个 E 级 |
| E    | 间接推断         | 1.0  | 基准        |

**目标完成度**: 每个研究方向的加权得分达到 50.0 分（相当于 10 个 A 级或 50 个 E 级）即为 100% 完成。阈值设置较高，目的是鼓励多轮迭代收集足够深度的证据。

### 4.3 收敛判断流程

每次研究迭代结束后，PlanAgent 执行一次收敛评估。这一评估决定两件事：**是否停止研究**（收敛），以及若继续研究时**每个方向的研究模式**（广度 / 深度 / 跳过）。

#### Step 1: 量化每方向的证据状态

系统首先自动计算每个研究方向的统计数据：

- **证据数量**: 该方向已收集多少条证据
- **等级分布**: A / B / C / D / E 各多少条
- **加权得分**: 按权重求和（A = 5 分，B = 3 分，…）
- **完成度**: 加权得分占目标分（50 分）的百分比

这些统计为 PlanAgent 提供量化参考，但不直接决定收敛——最终判断由 PlanAgent 综合做出。

#### Step 2: PlanAgent 综合评估（主路径）

PlanAgent 会收到每个方向的**完整证据详情**（实体、关系、观察），以及上一轮各研究 Agent 标记的**待深入研究线索**，然后：

1. **对每个方向进行证据评估**

   - 该方向的关键发现有哪些？证据等级如何？
   - 完成标准中哪些已被覆盖、哪些仍有缺口？
   - 综合判断该方向是否已具备足够的证据支撑
2. **对待深入研究线索逐条评判**

   - 该线索是否已被后续研究覆盖？（已覆盖 / 部分覆盖 / 未覆盖）
   - 对报告质量的影响程度？（关键 / 重要 / 次要）
   - 如果存在**关键或重要**的未覆盖线索，则该方向不应收敛
3. **为每个方向分配下轮模式并说明理由**（skip / 广度优先 / 深度优先）
4. **做出全局收敛决策**

   - 所有方向均已达标且无关键未覆盖线索 → **收敛**，停止研究
   - 否则 → **继续**，按新模式进入下一轮迭代

### 4.4 收敛阈值设计


| 阈值       | 值     | 含义                 |
| ------------ | -------- | ---------------------- |
| 收敛完成度 | ≥ 80% | 方向视为 "completed" |
| 继续研究线 | < 60%  | 方向仍需大量研究     |
| 中间地带   | 60-80% | 需要深度研究提升质量 |

**为什么是 80% 而不是 100%?**

- 临床研究中，100% 证据覆盖几乎不可能
- 80% 阈值确保核心证据到位，同时避免无限循环
- 对于低于 80% 的方向，PlanAgent 的判断可以灵活处理边缘情况

### 4.5 质量门控

除了完成度百分比，收敛还需通过以下质量检查：


| 检查项             | 判断逻辑                                   | 影响                                                                  |
| -------------------- | -------------------------------------------- | ----------------------------------------------------------------------- |
| **高质量覆盖**     | 是否有至少 1 条 A/B 级证据                 | 无高质量证据 → 不收敛                                                |
| **低质量警告**     | 是否全部为 D/E 级证据                      | 仅低质量 → 强制深度优先                                              |
| **模块覆盖**       | 9 个需要证据覆盖的模块是否都有对应研究方向 | 缺失模块 → 新增方向                                                  |
| **证据冲突**       | 是否存在矛盾证据                           | 有冲突 → 需要更多佐证                                                |
| **待深入研究线索** | 是否有关键或重要的待深入线索尚未被覆盖     | PlanAgent 逐条评判覆盖度和影响程度；回退路径中每条线索扣减 10% 完成度 |

需要证据覆盖的 9 个模块：


| 模块           | 主要负责 Agent       |
| ---------------- | ---------------------- |
| 治疗史回顾     | Chair 综合           |
| 治疗路线图     | Oncologist (Phase 2) |
| 药物/方案对比  | Oncologist (Phase 2) |
| 局部治疗建议   | Oncologist (Phase 2) |
| 临床试验推荐   | Recruiter            |
| 器官功能与剂量 | Oncologist (Phase 2) |
| 分子特征       | Geneticist           |
| 分子复查建议   | Geneticist           |
| 核心建议汇总   | Chair 综合           |

> **注**: 以下模块不纳入证据覆盖检查：执行摘要（Chair 综合生成，非方向驱动）、患者概况（PDF 直接提取）、完整证据引用列表（全 Agent 汇总）、证据等级说明（静态参考附录）。

### 4.6 强制收敛安全网

当达到最大迭代次数时，无论证据质量如何都强制收敛：

- 防止因判断不稳定导致无限循环
- 确保系统在有限时间和成本内产出结果
- 即使证据不完美，Chair 仍可基于已有信息生成报告，并标注证据不足的领域

---

## 5. 证据图设计决策

### 5.1 为什么选择 Entity-Edge-Observation

对比三种候选方案：


| 方案               | 优点                                                           | 缺点                         |
| -------------------- | ---------------------------------------------------------------- | ------------------------------ |
| **自由文本**       | 简单，LLM 原生格式                                             | 无法结构化查询、无法量化质量 |
| **表格/列表**      | 易于对比                                                       | 关系信息丢失、缺乏语义       |
| **知识图谱 (EEO)** | 结构化、可查询、可量化、图分析价值拓展、潜在关联和相互作用探索 | 实现复杂、需要实体提取       |

### 5.2 实体提取策略

每次研究迭代产出的文本发现，通过 LLM 提取为结构化实体：

```
Agent 原始发现:
  "CIViC 数据显示 EGFR L858R 变异对吉非替尼敏感，
   FLAURA 研究表明奥希替尼优于吉非替尼 (HR=0.46)"

            │ LLM 实体提取
            ▼

提取结果:
  实体: GENE:EGFR, EGFR_L858R, DRUG:GEFITINIB, DRUG:OSIMERTINIB
  边:   EGFR_L858R →SENSITIZES→ DRUG:GEFITINIB
        EGFR_L858R →SENSITIZES→ DRUG:OSIMERTINIB
  观察: "FLAURA: osimertinib vs gefitinib, HR=0.46"
        Grade: A, Type: predictive
```

### 5.3 Neo4j 图数据库集成

**数据模型**: Neo4j 中存储四类节点：

- **运行记录** — 每次系统运行的标识，关联患者和时间
- **实体** — 基因、变异、药物、疾病等，与证据图中的实体一一对应
- **关系证据** — 两个实体之间的关系（如"敏感"、"耐药"），以独立节点存储以便附加观察
- **观察** — 具体的事实陈述，包含证据等级、来源和贡献 Agent

**为什么将关系具体化为独立节点?** 证据图中的关系边本身携带支撑它的观察列表。在标准图数据库中，边无法拥有子节点。通过将关系具体化为独立节点，可以统一地为实体和关系都附加观察记录。

**跨运行查询能力**:

- 查询某个实体在所有历史运行（多个患者）中的观察和证据
- 检索某次运行的完整证据图

### 5.4 交互式可视化

- 探索特定实体的邻域（如"这个基因与哪些药物有什么关联？"）
- 按证据等级、实体类型或贡献 Agent 过滤
- 直观评估证据质量

**设计决策**: 在 HTML 报告中嵌入 Cytoscape.js 交互式证据图可视化。

**视觉编码设计**:


| 视觉属性     | 编码含义                                                 |
| -------------- | ---------------------------------------------------------- |
| 节点颜色     | 实体类型（蓝色=基因、橙色=变异、绿色=药物、粉色=疾病等） |
| 节点大小     | 观察数量（观察越多，节点越大）                           |
| 节点边框宽度 | 最高证据等级（A 级最粗，E 级最细）                       |
| 边颜色       | 关系类型（绿色=治疗、蓝色=敏感、红色=耐药等）            |
| 边宽度       | 置信度分数                                               |

**交互功能**:

- **过滤**: 按实体类型、证据等级（A-E）、贡献 Agent、文本搜索
- **布局切换**: 力导向、环形、树形等多种布局
- **节点详情面板**: 点击实体查看所有观察、等级、来源和连接
- **边详情面板**: 点击关系查看证据陈述和置信度

## 6. 模型分层策略

### 6.1 双层模型架构

系统为不同任务类型选择不同级别的模型：


| 任务类型                        | 模型层级   | 原因                                      |
| --------------------------------- | ------------ | ------------------------------------------- |
| 研究阶段（迭代搜索与工具调用）  | 轻量模型   | 研究迭代次数多，需要成本效率              |
| 报告生成（领域报告合成）        | 强推理模型 | 报告合成需要强推理，每个 Agent 仅调用一次 |
| 研究规划与收敛判断（PlanAgent） | 强推理模型 | 研究规划和收敛判断需要强分析推理          |
| 最终报告合成（Chair）           | 强推理模型 | 最终报告合成，复杂多源推理                |

**为什么区分研究阶段和报告阶段的模型?**

研究阶段中，Agent 大量调用工具并处理中间结果，这是信息收集密集型工作，轻量模型即可胜任。但最终报告生成需要将数百条证据观察综合为连贯的临床文本——这是推理密集型任务。

通过区分模型层级，研究阶段实现了 3-5 倍的成本降低，同时不牺牲报告质量。

### 6.2 温度设计


| Agent                             | 温度 | 原因                         |
| ----------------------------------- | ------ | ------------------------------ |
| Geneticist, Recruiter, Oncologist | 0.2  | 需要精确的事实分析，降低幻觉 |
| Pathologist, Chair, PlanAgent     | 0.3  | 需要一定的综合分析灵活性     |

---

## 7. 报告生成策略

### 7.1 报告合成流程

```
Phase 1 证据 ──────────────────────────────────────────┐
  ├── Pathologist 证据 → 病理领域报告                   │
  ├── Geneticist 证据  → 分子领域报告                   │
  └── Recruiter 证据   → 试验领域报告                   │
                                                         │
Phase 2 证据 ──────────────────────────────────────────┐│
  └── Oncologist 证据  → 治疗领域报告                   ││
                                                         ││
Chair 接收全部信息:                                      ││
  ├── 4 份领域报告 ─────────────────────────────────────┘│
  ├── 证据图 (只读) ───────────────────────────────────┘
  └── 原始 PDF 文本
            │
            ▼
    结构化终版报告
            │
            ▼
    HTML 报告 + 交互式证据图可视化
```


---

*文档版本: 2.0*
